<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏≠‡∏π‡πà</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
@import url('https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;700&display=swap');

*{
  font-family:'Kanit',system-ui,sans-serif !important;
}

body{margin:0;background:#f5f7fb}
.container{max-width:420px;margin:auto;padding:16px}
.tabs{background:#fff;border-radius:14px;display:flex;padding:6px;margin-bottom:16px;position:relative;overflow:hidden}
.tab{z-index:1;flex:1;text-align:center;padding:10px;border-radius:12px;color:#666;font-size:14px;cursor:pointer;transition:transform .15s ease, color .2s ease;position:relative}
.tab.active{color:#fff;font-weight:600}
h3{margin:10px 0;color:#e53935;font-size:18px;text-align:center}
.card{background:#fff;border-radius:18px;padding:16px;box-shadow:0 2px 8px rgba(0,0,0,.05)}
.row{display:flex;gap:10px;margin-bottom:12px}
.field{flex:1}
label{font-size:13px;color:#555}
input,select,textarea{width:100%;padding:10px;margin-top:4px;border-radius:12px;border:1px solid #ddd;font-size:14px;box-sizing:border-box}
textarea{min-height:70px;resize:none}
.upload{border:2px dashed #e53935;border-radius:16px;padding:18px;text-align:center;margin-top:12px;font-weight:500}
.upload.car{border-color:#2196f3;color:#2196f3;background:#e3f2fd}
.upload.bill{border-color:#e53935;color:#e53935;background:#fdecea}
.submit{margin-top:16px;width:100%;background:#2196f3;color:#fff;border:none;border-radius:16px;padding:14px;font-size:16px;font-weight:600;cursor:pointer;transition:transform .12s ease, box-shadow .12s ease}

.money-wrapper{position:relative}
.money-wrapper .unit{position:absolute;right:12px;top:50%;transform:translateY(-50%);color:#666;pointer-events:none}
.tab-indicator{position:absolute;top:6px;bottom:6px;left:6px;width:calc(50% - 6px);background:#e53935;border-radius:12px;transition:transform .25s ease;z-index:0}

.tab:active{transform:scale(.96)}
.submit:active{transform:scale(.96)}
.submit:focus{outline:none}
</style>
</head>
<body>
  <div class="container">
    <h2 style="text-align:center;margin:6px 0 14px;color:#2196f3"><i class="bi bi-speedometer2"></i> ‡πÄ‡∏Å‡∏°‡∏™‡πå ‡∏Ñ‡∏≠‡∏°‡∏°‡∏≠‡∏ô‡πÄ‡∏£‡∏•</h2>
    <div class="tabs">
      <div class="tab-indicator" id="tabIndicator"></div>
      <div class="tab active" id="tabForm"><i class="bi bi-tools"></i> ‡∏á‡∏≤‡∏ô‡∏ã‡πà‡∏≠‡∏°</div>
      <div class="tab" id="tabHistory"><i class="bi bi-clock-history"></i> ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</div>
    </div>
      

    <div id="formTab">
      <h3><i class="bi bi-tools"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏á‡∏≤‡∏ô‡∏ã‡πà‡∏≠‡∏°</h3>
      <div class="card">

        <div class="row">
          <div class="field">
            <label>‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</label>
            <input id="name" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏ä‡πà‡∏≤‡∏á‡πÄ‡∏≠‡∏Å">
          </div>
        </div>

        <div class="row">
          <div class="field">
            <label>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
            <input type="date" id="date">
          </div>
          <div class="field">
            <label>‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏£‡∏ñ</label>
            <input id="plate" placeholder="‡∏Å‡∏Ç 8888">
          </div>
          <div class="field">
            <label>‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£</label>
            <input id="phone" placeholder="08x-xxx-xxxx">
          </div>
        </div>

        <div class="row">
          <div class="field">
            <label>‡∏¢‡∏µ‡πà‡∏´‡πâ‡∏≠‡∏£‡∏ñ</label>
            <select id="brand">
              <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏¢‡∏µ‡πà‡∏´‡πâ‡∏≠...</option>
              <option>Toyota</option><option>Honda</option><option>Isuzu</option>
              <option>Mitsubishi</option><option>Nissan</option><option>Mazda</option>
              <option>Ford</option><option>MG</option><option>BYD</option>
              <option>Suzuki</option><option>BMW</option><option>Mercedes-Benz</option>
            </select>
          </div>
          <div class="field">
            <label>‡∏£‡∏∏‡πà‡∏ô‡∏£‡∏ñ</label>
            <select id="model">
              <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏∏‡πà‡∏ô‡∏£‡∏ñ</option>
            </select>
          </div>
          <div class="field">
            <label>‡∏õ‡∏µ‡∏£‡∏ñ</label>
            <input id="year" placeholder="2019">
          </div>
        </div>

        <label>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏Å‡πà‡∏≠‡∏ô‡∏ã‡πà‡∏≠‡∏°</label>
        <textarea></textarea>

        <label>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏´‡∏•‡∏±‡∏á‡∏ã‡πà‡∏≠‡∏°‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß</label>
        <textarea></textarea>

        <label>‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡∏£‡∏ß‡∏°</label>
        <div class="money-wrapper">
          <input id="price" placeholder="0" inputmode="numeric">
          <span class="unit">‡∏ö‡∏≤‡∏ó</span>
        </div>

        <div class="upload car" onclick="carImg.click()"><i class="bi bi-camera"></i> ‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ‡∏á‡∏≤‡∏ô / ‡∏£‡∏ñ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤
  <input type="file" id="carImg" accept="image/*" hidden onchange="previewImage(this,'carPreview')">
  <img id="carPreview" style="display:none;margin-top:10px;max-width:100px;border-radius:8px">
</div>

        <div class="upload bill" onclick="billImg.click()"><i class="bi bi-receipt"></i> ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏ö‡∏¥‡∏•‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î
  <input type="file" id="billImg" accept="image/*" hidden onchange="previewImage(this,'billPreview')">
  <img id="billPreview" style="display:none;margin-top:10px;max-width:100px;border-radius:8px">
</div>

        <button class="submit" onclick="saveData()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏á‡∏≤‡∏ô</button>
      </div>
    </div>

    <div id="historyTab" style="display:none">
      <h3><i class="bi bi-clock-history"></i> ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô‡∏ã‡πà‡∏≠‡∏°</h3>

      <input id="searchPlate" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ï‡∏≤‡∏°‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô" oninput="loadHistory()" style="margin-bottom:12px">

      <div id="historyList"></div>

<script>
// ===== CONFIG =====
const SHEET_API_URL = 'https://script.google.com/macros/s/AKfycbwiP5xv-S0EbCANvX1BwQeVciz-ovkAy4a44ULur4JfdHtIzo5gBFYoWQd-sA20J_-5/exec';


// ===== HISTORY LOAD =====
document.addEventListener('DOMContentLoaded', () => {
  loadHistory();
});

function loadHistory(keyword = '') {
  const url = keyword
    ? `${SHEET_API_URL}?q=${encodeURIComponent(keyword)}`
    : SHEET_API_URL;

fetch(url)
  .then(res => res.json())
  .then(res => {
    if (res.status === 'success') {
      renderHistory(res.data);
    } else {
      renderHistory([]);
    }
  })
    .catch(err => {
      const list = document.getElementById('historyList');
      list.innerHTML = '<div style="padding:20px;color:red">‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</div>';
      console.error(err);
    });
}

// ===== RENDER HISTORY =====
function renderHistory(data) {
  const list = document.getElementById("historyList");

  // ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
  if (!data || data.length === 0) {
    list.innerHTML =
      '<div style="text-align:center;padding:40px;color:#888;font-size:16px;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>';
    return;
  }

  let html = "";

  data.forEach(item => {
    const carImg = item.carImg
      ? `<img src="${item.carImg}" 
             style="width:120px;height:90px;object-fit:cover;border-radius:8px;border:1px solid #ddd;">`
      : `<div style="width:120px;height:90px;background:#f0f0f0;
                    display:flex;align-items:center;justify-content:center;
                    border-radius:8px;color:#999;font-size:12px;">
           ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏π‡∏õ
         </div>`;

    const billButton = item.billImg
      ? `<button onclick="window.open('${item.billImg}','_blank')" 
                style="background:#17a2b8;">‡∏î‡∏π‡∏ö‡∏¥‡∏•</button>`
      : "";

    html += `
      <div style="
        display:flex;
        gap:15px;
        background:#ffffff;
        padding:15px;
        margin-bottom:15px;
        border-radius:12px;
        box-shadow:0 3px 8px rgba(0,0,0,0.08);
        align-items:center;
      ">

        <div>${carImg}</div>

        <div style="flex:1;">
          <div style="font-weight:bold;font-size:16px;">
            ${item.name || '-'}
          </div>

          <div style="font-size:14px;color:#555;">
            üìÖ ${item.date || '-'}
          </div>

          <div style="font-size:14px;color:#555;">
            üöó ${item.brand || ''} ${item.model || ''} (${item.year || ''})
          </div>

          <div style="font-size:14px;color:#555;">
            üè∑ ‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô: ${item.plate || '-'}
          </div>

          <div style="font-size:14px;color:#28a745;font-weight:bold;margin-top:4px;">
            üí∞ ${item.price || 0} ‡∏ö‡∏≤‡∏ó
          </div>

          <div style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap;">
            <button onclick="editData('${item.id}')"
                    style="background:#ffc107;">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>

            <button onclick="deleteData('${item.id}')"
                    style="background:#dc3545;color:#fff;">‡∏•‡∏ö</button>

            ${billButton}
          </div>
        </div>
      </div>
    `;
  });

  list.innerHTML = html;
}

// ===== SAVE FORM =====
function saveData() {

  const formData = new URLSearchParams();

  const carPreview = document.getElementById('carPreview');
  const billPreview = document.getElementById('billPreview');

  formData.append(
    "carImg",
    carPreview.src && carPreview.src.startsWith("data:image")
      ? carPreview.src
      : ""
  );

  formData.append(
    "billImg",
    billPreview.src && billPreview.src.startsWith("data:image")
      ? billPreview.src
      : ""
  );

  formData.append("mode", window.editingId ? "update" : "save");
  formData.append("id", window.editingId || "");
  formData.append("date", document.getElementById('date').value);
  formData.append("name", document.getElementById('name').value);
  formData.append("plate", document.getElementById('plate').value);
  formData.append("phone", document.getElementById('phone').value);
  formData.append("brand", document.getElementById('brand').value);
  formData.append("model", document.getElementById('model').value);
  formData.append("year", document.getElementById('year').value);
  formData.append("price", getPriceNumber());

  fetch(SHEET_API_URL, {
    method: "POST",
    body: formData,
    headers: {
      "Content-Type": "application/x-www-form-urlencoded"
    }
  })
  .then(res => res.json())
  .then(res => {
    if (res.status === "success") {
      alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢");
      window.editingId = null;
      loadHistory();
      showTab('history');
    } else {
      alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
      console.log(res);
    }
  })
  .catch(err => {
    alert("‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
    console.error(err);
  });
}



// ===== UTIL =====
function formatMoney(val) {
  if (!val) return '0';
  return Number(val).toLocaleString('th-TH');
}

</script>
    </div>
    </div>
  </div>

<script>
// tab control (FIX)
document.getElementById('tabForm').onclick = () => showTab('form');
document.getElementById('tabHistory').onclick = () => showTab('history');

function showTab(tab){
  const indicator = document.getElementById('tabIndicator');
  document.getElementById('formTab').style.display = tab==='form'?'block':'none';
  document.getElementById('historyTab').style.display = tab==='history'?'block':'none';
  document.getElementById('tabForm').classList.remove('active');
  document.getElementById('tabHistory').classList.remove('active');

  if(tab==='form'){
    document.getElementById('tabForm').classList.add('active');
    indicator.style.transform = 'translateX(0%)';
  }else{
    document.getElementById('tabHistory').classList.add('active');
    indicator.style.transform = 'translateX(100%)';
    loadHistory();
  }
}

// ===== money format =====
const priceInput = document.getElementById('price');
priceInput.addEventListener('input',()=>{
  let v = priceInput.value.replace(/[^0-9]/g,'');
  priceInput.value = v ? Number(v).toLocaleString('en-US') : '';
});

function getPriceNumber(){
  return Number(priceInput.value.replace(/,/g,''))||0;
}

// ===== brand & model real data (Thailand) =====
const brandModelMap = {
  "Toyota": ["Vios","Yaris","Altis","Corolla Cross","Camry","Revo","Fortuner","Avanza","Innova","Hilux Champ"],
  "Honda": ["City","Jazz","Civic","Accord","HR-V","CR-V","BR-V","Mobilio"],
  "Isuzu": ["D-Max","MU-X"],
  "Mazda": ["Mazda 2","Mazda 3","CX-3","CX-30","CX-5","CX-8","BT-50"],
  "Nissan": ["Almera","March","Note","Sylphy","Teana","Navara","Terra"],
  "Mitsubishi": ["Attrage","Mirage","Lancer","Xpander","Pajero Sport","Triton"],
  "Ford": ["Ranger","Everest","EcoSport"],
  "MG": ["MG3","MG4","MG5","MG ZS","MG HS","MG Extender"],
  "BYD": ["Dolphin","Atto 3","Seal"],
  "Suzuki": ["Celerio","Swift","Ciaz","Ertiga","Carry"],
  "BMW": ["Series 3","Series 5","X1","X3","X5"],
  "Mercedes-Benz": ["A-Class","C-Class","E-Class","GLA","GLC"]
};

const brandSelect = document.getElementById('brand');
const modelSelect = document.getElementById('model');

brandSelect.addEventListener('change',()=>{
  const brand = brandSelect.value;
  modelSelect.innerHTML = '<option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏∏‡πà‡∏ô‡∏£‡∏ñ</option>';
  if(!brandModelMap[brand]) return;
  brandModelMap[brand].forEach(m=>{
    const opt = document.createElement('option');
    opt.value = m;
    opt.textContent = m;
    modelSelect.appendChild(opt);
  });
});

// ===== ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏•‡∏ö =====
function deleteData(id) {
  if (!confirm("‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö?")) return;

  fetch(SHEET_API_URL + "?action=delete&id=" + id)
    .then(res => res.json())
    .then(res => {
      if (res.status === "success") {
        loadHistory();
      }
    })
    .catch(err => {
      console.error(err);
      alert("‡∏•‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
    });
}
// ===== ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç =====  
function editData(id) {
  fetch(SHEET_API_URL)
    .then(res => res.json())
    .then(res => {
      if (!res.data) return;
      const item = res.data.find(d => d.id === id);
      if (!item) return;

      document.getElementById('date').value = item.date;
      document.getElementById('name').value = item.name;
      document.getElementById('plate').value = item.plate;
      document.getElementById('phone').value = item.phone;
      document.getElementById('brand').value = item.brand;

// trigger change ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏∏‡πà‡∏ô
brandSelect.dispatchEvent(new Event('change'));

setTimeout(()=>{
  document.getElementById('model').value = item.model;
}, 100);
      
      document.getElementById('year').value = item.year;
      document.getElementById('price').value = item.price;

      window.editingId = id;

      showTab('form');
    });
}

 function previewImage(input, id){
  const img = document.getElementById(id);

  if(input.files && input.files[0]){

    const reader = new FileReader();

    reader.onload = function(e){

      const image = new Image();
      image.src = e.target.result;

      image.onload = function(){

        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');

        const MAX_WIDTH = 600; // ‡∏õ‡∏£‡∏±‡∏ö‡πÑ‡∏î‡πâ
        const scale = MAX_WIDTH / image.width;

        canvas.width = MAX_WIDTH;
        canvas.height = image.height * scale;

        ctx.drawImage(image, 0, 0, canvas.width, canvas.height);

        // ‡∏ö‡∏µ‡∏ö‡∏≠‡∏±‡∏î‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏û 70%
        const compressed = canvas.toDataURL('image/jpeg', 0.7);

        img.src = compressed;
        img.style.display = 'block';
      };
    };

    reader.readAsDataURL(input.files[0]);
  }
} 
</script>
</body>
</html>






















